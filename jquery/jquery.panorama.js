$.fn.panorama=function(n){this.each(function(){var t,e,i,a,s={views_number:120,views_columns:20},o=this,r=$(this).attr("src"),p=0,l=0,c=0,d=!1,u=!1,_=parseInt($(o).attr("width"));t=parseInt(_/2);var g=parseInt($(o).attr("height"));e=parseInt(g/2),$(o).css("margin","0 0 0 0").css("padding","0 0 0 0").wrap('<div class="panorama" style="position: relative; margin: auto; padding: 0; height: '+g+"px; width: "+_+'px; overflow: hidden;"></div>'),n&&$.extend(s,n),$(o).after('<a class="pano_loading_stop" href="#" style="display: none; color: white; position: absolute; top: 5px; right: 5px; text-decoration: none;">[stop]</a>'),s.views_columns==s.views_number?$(o).after('<p class="pano_loading_percent" style="position: absolute; display: none; top: '+parseInt(g/2-44)+"px; left: "+parseInt(_/2-40)+'px; text-align: center; width:90px; height:90px;"><img src="/test/images/product-detail/loading.gif" alt="loading" /><span style="position:relative;height:18px;display:block;width:80px;margin:-29px auto 0 auto;font-size:12px;color:#333;background:#f0efed;">0 %</span></p>'):$(o).after('<p class="pano_loading_percent" style="position: absolute; display: none; top: '+parseInt(g/2-45)+"px; left: "+parseInt(_/2-45)+'px; text-align: center; width:90px; height:90px;"><img src="/test/images/loading.gif" alt="loading" /><span style="position:relative;height:18px;display:block;width:80px;margin:-29px auto 0 auto;font-size:12px;color:#333;background:#f0efed;">0 %</span></p>');var m=r.substr(0,r.lastIndexOf("_")+1),f=parseInt(r.substr(r.lastIndexOf("_")+1));i=f;var h=r.split("."),v="."+h[h.length-1];s.views_columns==s.views_number?$(o).after('<p class="pano_loading_start" style="position: absolute; top: '+parseInt(g/2-44)+"px; left: "+parseInt(_/2-40)+'px;text-align: center; width:90px; height:90px;"><a href="#"><img src="/images/product-detail/btn_start.png" alt="Start" /></a></p>'):$(o).after('<p class="pano_loading_start" style="position: absolute; top: '+parseInt(g/2-45)+"px; left: "+parseInt(_/2-45)+'px;text-align: center; width:90px; height:90px;"><a href="#"><img src="/Content/images/btn_start2.png" alt="Start" /></a></p>'),$(o).after('<div class="pano_loading_masque" style="position: absolute; top: 0; left: 0; width: '+_+"px; height: "+g+'px; opacity: .5; filter:alpha(opacity=50);"></div>'),$(o).parent().find(".pano_loading_stop").bind("click",function(){return u=!0,!1}),$(o).parent().find(".pano_loading_start a").bind("click",function(){return $(o).parent().css("cursor","wait"),$(o).parent().find(".pano_loading_start").hide(),$(o).parent().find(".pano_loading_percent").show(),$(o).parent().find(".pano_loading_animation").show(),$(o).parent().find(".pano_vues").remove(),a=setTimeout(function(){clearTimeout(a);for(var n=0;n<s.views_number;n++)n!=f&&($(o).after('<img class="pano_vues vue'+n+'" src="'+m+n+v+'" style="visibility: hidden;" />'),$(o).parent().find("img.vue"+n).bind("load",function(){p++,u&&(u=!1,$(o).parent().css("cursor","default"),$(o).parent().find(".pano_loading_percent").hide(),$(o).parent().find(".pano_loading_start").show(),$(o).parent().find(".pano_loading_percent span").html("loading"),a=setTimeout(function(){clearTimeout(a),window.stop()})),parseInt(p/s.views_number*100)>90?($(o).parent().css("cursor","pointer"),$(o).parent().find(".pano_loading_percent").hide(),$(o).parent().find(".pano_loading_animation").hide(),$(o).parent().find(".pano_loading_masque").hide(),$(o).bind("mousedown",function(n){return d=!0,t=n.clientX,e=n.clientY,$(o).parent().css("cursor","move"),!1}),$(o).bind("mouseup",function(){return d=!1,$("div.panorama").css("cursor","pointer"),!1}),$(o).bind("mousemove",function(n){if(d&&(l=parseInt((t-n.clientX)/20),c=parseInt((e-n.clientY)/20),0!=l||0!=c)){"( "+n.pageX+", "+n.pageY+" )","( "+n.clientX+", "+n.clientY+" )";i=s.views_columns==s.views_number?i-l-s.views_columns*c:i+l+s.views_columns*c,0>i&&(i=s.views_columns-1),i>s.views_number-1&&(i=s.views_number-s.views_columns),$(o).attr("src",m+i+v),t=n.clientX,e=n.clientY}return!1}),o.addEventListener("touchstart",function(n){var i=n.changedTouches[0];return d=!0,t=i.clientX,e=i.clientY,$(o).parent().css("cursor","move"),!1}),o.addEventListener("touchend",function(){return d=!1,$("div.panorama").css("cursor","pointer"),!1}),o.addEventListener("touchmove",function(n){if(d){var a=n.changedTouches[0];if(l=parseInt((t-a.clientX)/20),c=parseInt((e-a.clientY)/20),0!=l||0!=c){"( "+a.pageX+", "+a.pageY+" )","( "+a.clientY+", "+a.clientY+" )";i=s.views_columns==s.views_number?i-l-s.views_columns*c:i+l+s.views_columns*c,0>i&&(i=s.views_columns-1),i>s.views_number-1&&(i=s.views_number-s.views_columns),$(o).attr("src",m+i+v),t=a.clientX,e=a.clientY}}return!1})):$(o).parent().find(".pano_loading_percent span").html(parseInt(p/s.views_number*100)+" %")}))},500),!1})})};